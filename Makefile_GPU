CC=gcc
NVCC=nvcc

CCFLAGS=-c -Wall -pedantic -Iinclude/cpu
NVCCFLAGS=-c -Iinclude/gpu -arch=sm_20

LDFLAGS= -lm

BINDIR=bin/
OBJDIR=obj/
SRCDIR=src/

CPUSRCDIR=$(SRCDIR)/cpu/
GPUSRCDIR=$(SRCDIR)/gpu/

CPUBIN=$(BINDIR)mcmc
GPUBIN=$(BINDIR)gpu-mcmc

CCOBJDIR=$(OBJDIR)cpu/
NVCCOBJDIR=$(OBJDIR)gpu/

DEP+=getopts readGrp readData config  
DEP+=printArrays printConfig printChain printHeaders
DEP+=allocChain newChain runChain resetChain freeChain
DEP+=runiform rnormal rgamma rbeta
DEP+=phi alp del phiAlpDelJoint phiAlpDel
DEP+=c sigC eta d tau eps
DEP+=thePhi theAlp theDel
DEP+=sigPhi sigAlp sigDel
DEP+=piAlp piDel
DEP+=interimResults summarizeChain
DEP+=updateDICprep dic
DEP+=mcmc main

CCDEP=mu logLik $(DEP)
NVCCDEP=chainDeviceToHost $(DEP)

CCOBJ=$(foreach name, $(CCDEP), $(CCOBJDIR)$(name).o)
NVCCOBJ=$(foreach name, $(NVCCDEP), $(NVCCOBJDIR)$(name).o)

all: cpu gpu

cpu: $(CPUBIN)
	
$(CPUBIN): $(CCOBJ) 
	$(CC) $(CCOBJ) $(LDFLAGS) -o $(CPUBIN) 

$(CCOBJDIR)%.o: $(CPUSRCDIR)%.c cpudirs
	$(CC) $(CCFLAGS) $< -o $@ 

gpu: $(GPUBIN)
	
$(GPUBIN): $(NVCCOBJ) 
	$(NVCC) $(NVCCOBJ) $(LDFLAGS) -o $(GPUBIN) 

$(NVCCOBJDIR)%.o: $(GPUSRCDIR)%.cu gpudirs
	$(NVCC) $(NVCCFLAGS) $< -o $@ 

.INTERMEDIATE: cpudirs gpudirs dirs

cpudirs: dirs
	mkdir -p $(CCOBJDIR)

gpudirs: dirs
	mkdir -p $(NVCCOBJDIR)

dirs:
	mkdir -p $(BINDIR)
	mkdir -p $(OBJDIR)

clean:
	rm -rf $(OBJDIR)
	rm -rf $(BINDIR)